<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>å…‰ä¼æ¸…æ´—æ— äººæœºèˆªçº¿æ¨¡æ‹Ÿæ¼”ç¤ºç³»ç»Ÿ</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: white;
            padding: 0;
            margin: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .container {
            width: 98vw;
            height: 92vh;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: transparent;
            padding: 0.5%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1%;
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            color: #2c3e50;
        }

        .header-left h1 {
            font-size: 1.5vw;
            white-space: nowrap;
            color: #2c3e50;
        }

        .header-center {
            display: none;
        }

        .header-right {
            display: none;
        }

        .controls {
            display: flex;
            gap: 1%;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-start;
            background: white;
            padding: 1%;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 0.8%;
        }

        .controls button, .controls .file-label {
            padding: 0.5% 1.2%;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8vw;
            transition: all 0.2s;
            white-space: nowrap;
            color: white;
            font-weight: bold;
        }

        .controls button {
            background: #3498db;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
        }

        .controls button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .controls button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .demo-btn {
            background: #e74c3c !important;
            box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3) !important;
        }

        .demo-btn:hover {
            background: #c0392b !important;
        }

        #fileInput {
            display: none;
        }

        .file-label {
            background: #27ae60;
            color: white;
            padding: 0.4% 1%;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(39, 174, 96, 0.3);
            transition: all 0.2s;
            font-size: 0.7vw;
            white-space: nowrap;
        }

        .file-label:hover {
            background: #229954;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.4);
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 0.5%;
            font-size: 0.65vw;
            white-space: nowrap;
            color: #2c3e50;
        }

        .speed-control label {
            margin: 0;
        }

        .speed-control input {
            width: 100px;
            height: 4px;
            cursor: pointer;
        }

        .speed-control span {
            min-width: 50px;
        }

        .progress-bar {
            width: 100%;
            max-width: 200px;
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-container {
            width: 100%;
            background: white;
            padding: 1%;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 0.8%;
            position: relative;
        }

        .logo-container {
            position: absolute;
            top: 1%;
            right: 1%;
            z-index: 100;
        }

        .logo-container img {
            height: 5vh;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .logo {
            display: none;
        }

        .global-logo {
            position: fixed;
            top: 1%;
            right: 1%;
            z-index: 1000;
            height: 11.25vh;
            border-radius: 6px;
            box-shadow: none;
        }

        .grid {
            display: flex;
            gap: 1%;
            flex: 1;
            background: transparent;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 1%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        .panel:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
        }

        .panel-full-height {
            flex: 1;
        }

        .panel-title {
            font-weight: bold;
            font-size: 0.9vw;
            margin-bottom: 1%;
            color: #2c3e50;
            padding-bottom: 0.5%;
        }

        .legend {
            margin-top: 0.5%;
            font-size: 0.75vw;
            display: flex;
            gap: 1%;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-line {
            width: 2vw;
            height: 0.2vw;
            display: inline-block;
        }

        .legend-solid {
            background: #2196F3;
        }

        .legend-dashed {
            background: repeating-linear-gradient(
                to right,
                #f44336 0px,
                #f44336 5px,
                transparent 5px,
                transparent 10px
            );
        }

        #mapContainer {
            flex: 1;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1%;
            overflow-y: auto;
            max-height: 100%;
            min-width: 280px;
        }

        .table-wrapper {
            background: white;
            border-radius: 8px;
            padding: 1%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .table-title {
            font-weight: bold;
            font-size: 0.85vw;
            margin-bottom: 0.8%;
            color: #2c3e50;
            padding-bottom: 0.5%;
        }

        .table-panel {
            overflow-y: auto;
            flex: 1;
        }

        .info-table {
            width: 100%;
            font-size: 0.75vw;
            border-collapse: collapse;
            table-layout: auto;
        }

        .info-table tr {
            border-bottom: 1px solid #ecf0f1;
        }

        .info-table tr:last-child {
            border-bottom: none;
        }

        .info-table td {
            padding: 0.6% 1%;
            text-align: left;
        }

        .info-table td:first-child {
            background-color: #f5f5f5;
            font-weight: bold;
            width: 50%;
            color: #2c3e50;
        }

        .info-table td:last-child {
            text-align: left;
            color: #34495e;
        }

        .status-on {
            color: #27ae60;
            font-weight: bold;
        }

        .status-off {
            color: #e74c3c;
            font-weight: bold;
        }

        /* Leaflet åœ°å›¾æ ·å¼è°ƒæ•´ */
        .leaflet-container {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        }

        .leaflet-control-attribution {
            font-size: 0.65vw;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>æ— äººæœºé£è¡Œå®æ—¶ç›‘æ§ç³»ç»Ÿ</h1>
            </div>
        </div>

        <div class="grid">
            <!-- å·¦ä¾§ï¼š2Dèˆªçº¿åœ°å›¾ -->
            <div class="panel panel-full-height">
                <div class="panel-title">ğŸ“ 2D èˆªçº¿ä¿¯è§†å›¾ï¼ˆOpenStreetMapï¼‰</div>
                <div id="mapContainer"></div>
                <div class="legend">
                    <div class="legend-item">
                        <span class="legend-line legend-solid"></span>
                        <span>åŒºå—å†…èˆªçº¿</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-line legend-dashed"></span>
                        <span>åŒºå—é—´èˆªçº¿</span>
                    </div>
                    <div class="legend-item">
                        <span style="display:inline-block; width:12px; height:12px; background:#4CAF50; border-radius:50%; margin:0 5px;"></span>
                        <span>èµ·ç‚¹</span>
                    </div>
                    <div class="legend-item">
                        <span style="display:inline-block; width:12px; height:12px; background:#f44336; border-radius:50%; margin:0 5px;"></span>
                        <span>ç»ˆç‚¹</span>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ§åˆ¶ä¸è¡¨æ ¼åŒºåŸŸ -->
            <div class="right-panel">
                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="controls">
                    <label for="fileInput" class="file-label">ğŸ“‚ é€‰æ‹©CSVæ–‡ä»¶</label>
                    <input type="file" id="fileInput" accept=".csv">
                    <button id="loadDemoBtn" class="demo-btn">ğŸ“„ åŠ è½½æ¼”ç¤ºæ–‡ä»¶</button>
                    <button id="startBtn" disabled>â–¶ï¸ å¼€å§‹é£è¡Œ</button>
                    <button id="pauseBtn" disabled>â¸ï¸ æš‚åœ</button>
                    <button id="resetBtn" disabled>ğŸ”„ é‡ç½®</button>
                </div>

                <!-- è¿›åº¦æ¡ -->
                <div class="progress-container">
                    <div style="display:flex; gap:1%; align-items:center; margin-bottom:0.5%;">
                        <label style="font-size:0.75vw; color:#2c3e50; white-space:nowrap;">é£è¡Œé€Ÿåº¦:</label>
                        <input type="range" id="speedSlider" min="0.1" max="15" step="0.1" value="10" style="flex:1; height:4px;">
                        <span id="speedValue" style="font-size:0.75vw; color:#2c3e50; min-width:50px;">10.0 m/s</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:1%;">
                        <label style="font-size:0.75vw; color:#2c3e50; white-space:nowrap;">è¿›åº¦<span id="progressPercent" style="font-weight:bold;">0%</span>:</label>
                        <div class="progress-bar" style="flex:1;">
                            <div class="progress-fill" id="progressBar"></div>
                        </div>
                    </div>
                </div>

                <!-- è¡¨1: èˆªçº¿ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="table-wrapper">
                    <div class="table-title">ğŸ“Š èˆªçº¿ç»Ÿè®¡ä¿¡æ¯</div>
                    <div class="table-panel">
                        <table class="info-table">
                            <tr>
                                <td>èˆªçº¿æ€»é•¿åº¦</td>
                                <td id="totalDistance">0.00 m</td>
                            </tr>
                            <tr>
                                <td>å·²æ¸…æ´—é•¿åº¦</td>
                                <td id="cleanedDistance">0.00 m</td>
                            </tr>
                            <tr>
                                <td>å‰©ä½™é•¿åº¦</td>
                                <td id="remainingDistance">0.00 m</td>
                            </tr>
                            <tr>
                                <td>æ¸…æ´—è¦†ç›–ç‡</td>
                                <td id="coverageRate">0.0 %</td>
                            </tr>
                            <tr style="border-top: 2px solid #3498db;">
                                <td>å¹³å‡é«˜åº¦</td>
                                <td id="avgHeight">0.00 m</td>
                            </tr>
                            <tr>
                                <td>æœ€ä½é«˜åº¦</td>
                                <td id="minHeight">0.00 m</td>
                            </tr>
                            <tr>
                                <td>æœ€é«˜é«˜åº¦</td>
                                <td id="maxHeight">0.00 m</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- è¡¨2: å®æ—¶é£è¡Œå‚æ•° -->
                <div class="table-wrapper">
                    <div class="table-title">ğŸ¯ å®æ—¶é£è¡Œå‚æ•°</div>
                    <div class="table-panel">
                        <table class="info-table">
                            <tr>
                                <td>å½“å‰èˆªç‚¹</td>
                                <td id="currentWaypoint">1 / 0</td>
                            </tr>
                            <tr>
                                <td>ç»åº¦</td>
                                <td id="longitude">0.000000Â°</td>
                            </tr>
                            <tr>
                                <td>çº¬åº¦</td>
                                <td id="latitude">0.000000Â°</td>
                            </tr>
                            <tr>
                                <td>é«˜åº¦</td>
                                <td id="altitude">0.00 m</td>
                            </tr>
                            <tr style="border-top: 2px solid #3498db;">
                                <td>å½“å‰èˆªçº¿ID</td>
                                <td id="routeId">0</td>
                            </tr>
                            <tr>
                                <td>èˆªçº¿çŠ¶æ€</td>
                                <td id="routeStatus">å¾…æœºä¸­</td>
                            </tr>
                            <tr style="border-top: 2px solid #3498db;">
                                <td>æ¸…æ´—ç³»ç»Ÿ</td>
                                <td id="sprayStatus" class="status-off">å…³é—­ â­•</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logo -->
    <img src="TAS_logo.jpg" alt="TAS Logo" class="global-logo">

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let waypointData = [];
        let animationId = null;
        let currentIndex = 0;
        let isPaused = false;
        let totalDistance = 0;
        let cleanedDistance = 0;
        let animationSpeed = 10;
        
        // Leaflet åœ°å›¾å¯¹è±¡
        let map = null;
        let pathPolyline = null;
        let droneMarker = null;
        let startMarker = null;
        let endMarker = null;
        let routeLayer = null;

        // DOMå…ƒç´ 
        const fileInput = document.getElementById('fileInput');
        const loadDemoBtn = document.getElementById('loadDemoBtn');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');

        // åˆå§‹åŒ–åœ°å›¾å®¹å™¨
        function initMap() {
            if (map) map.remove();
            
            map = L.map('mapContainer').setView([30, 120], 10);
            
            // æ·»åŠ å«æ˜Ÿå›¾å±‚ï¼ˆEsri Satelliteï¼‰
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Â© Esri',
                maxZoom: 18,
                minZoom: 5
            }).addTo(map);

            // åˆ›å»ºèˆªçº¿å›¾å±‚ç»„
            routeLayer = L.layerGroup().addTo(map);
        }

        // æ–‡ä»¶ä¸Šä¼ 
        fileInput.addEventListener('change', handleFileUpload);
        loadDemoBtn.addEventListener('click', loadDemoFile);
        startBtn.addEventListener('click', startAnimation);
        pauseBtn.addEventListener('click', togglePause);
        resetBtn.addEventListener('click', resetAnimation);
        speedSlider.addEventListener('input', (e) => {
            animationSpeed = parseFloat(e.target.value);
            speedValue.textContent = animationSpeed.toFixed(1) + ' m/s';
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file);
        }

        function loadDemoFile() {
            // æ”¯æŒæœ¬åœ°file://åè®®çš„åŠ è½½
            fetch('15_3D_waypoints_debug.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('æ— æ³•åŠ è½½æ¼”ç¤ºæ–‡ä»¶');
                    }
                    return response.text();
                })
                .then(text => {
                    parseCSV(text);
                })
                .catch(error => {
                    // é™çº§å¤„ç†ï¼šå°è¯•XMLHttpRequest
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', '15_3D_waypoints_debug.csv', true);
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            parseCSV(xhr.responseText);
                        } else {
                            alert('âŒ åŠ è½½æ¼”ç¤ºæ–‡ä»¶å¤±è´¥: ' + xhr.statusText + '\nè¯·ç¡®ä¿ 15_3D_waypoints_debug.csv æ–‡ä»¶ä¸HTMLåœ¨åŒä¸€ç›®å½•');
                        }
                    };
                    xhr.onerror = function() {
                        alert('âŒ åŠ è½½æ¼”ç¤ºæ–‡ä»¶å¤±è´¥\nè¯·ç¡®ä¿ 15_3D_waypoints_debug.csv æ–‡ä»¶ä¸HTMLåœ¨åŒä¸€ç›®å½•');
                    };
                    xhr.send();
                });
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            
            waypointData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length < 6) continue;
                
                waypointData.push({
                    id: parseInt(values[0]),
                    type: parseInt(values[1]),
                    route: parseInt(values[2]),
                    lon: parseFloat(values[3]),
                    lat: parseFloat(values[4]),
                    alt: parseFloat(values[5])
                });
            }

            if (waypointData.length > 0) {
                calculateStatistics();
                initializeVisualization();
                startBtn.disabled = false;
                resetBtn.disabled = false;
                alert(`âœ… æˆåŠŸåŠ è½½ ${waypointData.length} ä¸ªèˆªç‚¹`);
            }
        }

        function calculateStatistics() {
            totalDistance = 0;
            for (let i = 0; i < waypointData.length - 1; i++) {
                const p1 = waypointData[i];
                const p2 = waypointData[i + 1];
                const dx = (p2.lon - p1.lon) * 111320 * Math.cos(p1.lat * Math.PI / 180);
                const dy = (p2.lat - p1.lat) * 111320;
                const dz = p2.alt - p1.alt;
                totalDistance += Math.sqrt(dx * dx + dy * dy + dz * dz);
            }

            const altitudes = waypointData.map(w => w.alt);
            const avgAlt = altitudes.reduce((a, b) => a + b, 0) / altitudes.length;
            const minAlt = Math.min(...altitudes);
            const maxAlt = Math.max(...altitudes);

            document.getElementById('totalDistance').textContent = totalDistance.toFixed(2) + ' m';
            document.getElementById('avgHeight').textContent = avgAlt.toFixed(2) + ' m';
            document.getElementById('minHeight').textContent = minAlt.toFixed(2) + ' m';
            document.getElementById('maxHeight').textContent = maxAlt.toFixed(2) + ' m';
        }

        function initializeVisualization() {
            if (!map) initMap();
            
            routeLayer.clearLayers();
            
            // ç»˜åˆ¶èˆªçº¿
            for (let i = 0; i < waypointData.length - 1; i++) {
                const p1 = [waypointData[i].lat, waypointData[i].lon];
                const p2 = [waypointData[i + 1].lat, waypointData[i + 1].lon];

                if (waypointData[i].type === 3 && waypointData[i + 1].type === 3) {
                    // åŒºå—å†…ï¼šå®çº¿è“è‰²
                    L.polyline([p1, p2], {
                        color: '#2196F3',
                        weight: 3,
                        opacity: 0.8,
                        dashArray: null
                    }).addTo(routeLayer);
                } else {
                    // åŒºå—é—´ï¼šè™šçº¿çº¢è‰²
                    L.polyline([p1, p2], {
                        color: '#f44336',
                        weight: 3,
                        opacity: 0.8,
                        dashArray: '8, 4'
                    }).addTo(routeLayer);
                }
            }

            // ç»˜åˆ¶èµ·ç‚¹å’Œç»ˆç‚¹
            if (startMarker) routeLayer.removeLayer(startMarker);
            if (endMarker) routeLayer.removeLayer(endMarker);

            const startPos = [waypointData[0].lat, waypointData[0].lon];
            startMarker = L.circleMarker(startPos, {
                radius: 10,
                fillColor: '#4CAF50',
                color: '#2e7d32',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            }).bindPopup('èµ·ç‚¹').addTo(routeLayer);

            const endPos = [waypointData[waypointData.length - 1].lat, waypointData[waypointData.length - 1].lon];
            endMarker = L.circleMarker(endPos, {
                radius: 10,
                fillColor: '#f44336',
                color: '#c62828',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            }).bindPopup('ç»ˆç‚¹').addTo(routeLayer);

            // è‡ªåŠ¨ç¼©æ”¾åˆ°è·¯çº¿èŒƒå›´
            const latLngs = waypointData.map(w => [w.lat, w.lon]);
            const bounds = L.latLngBounds(latLngs);
            map.fitBounds(bounds, { padding: [50, 50] });

            currentIndex = 0;
            cleanedDistance = 0;
            updateUI();
        }

        function startAnimation() {
            if (currentIndex >= waypointData.length) {
                currentIndex = 0;
                cleanedDistance = 0;
            }
            
            startBtn.disabled = true;
            pauseBtn.disabled = false;
            isPaused = false;
            animate();
        }

        function togglePause() {
            isPaused = !isPaused;
            pauseBtn.textContent = isPaused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ';
            if (!isPaused) animate();
        }

        function resetAnimation() {
            if (animationId) cancelAnimationFrame(animationId);
            currentIndex = 0;
            cleanedDistance = 0;
            isPaused = false;
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            pauseBtn.textContent = 'â¸ï¸ æš‚åœ';
            
            if (droneMarker) routeLayer.removeLayer(droneMarker);
            droneMarker = null;
            
            updateUI();
        }

        function animate() {
            if (isPaused || currentIndex >= waypointData.length) {
                if (currentIndex >= waypointData.length) {
                    alert('âœ… é£è¡Œå®Œæˆï¼');
                    resetAnimation();
                }
                return;
            }

            const waypoint = waypointData[currentIndex];
            
            // æ›´æ–°æ¸…æ´—è·ç¦»
            if (currentIndex > 0 && waypoint.type === 3 && waypointData[currentIndex - 1].type === 3) {
                const prev = waypointData[currentIndex - 1];
                const dx = (waypoint.lon - prev.lon) * 111320 * Math.cos(prev.lat * Math.PI / 180);
                const dy = (waypoint.lat - prev.lat) * 111320;
                const dz = waypoint.alt - prev.alt;
                cleanedDistance += Math.sqrt(dx * dx + dy * dy + dz * dz);
            }

            updateUI();
            drawDrone(waypoint);

            currentIndex++;
            
            // è®¡ç®—å»¶è¿Ÿï¼ˆåŸºäºè®¾å®šçš„é£è¡Œé€Ÿåº¦ï¼‰
            let delay = 50;
            if (currentIndex < waypointData.length) {
                const next = waypointData[currentIndex];
                const dx = (next.lon - waypoint.lon) * 111320 * Math.cos(waypoint.lat * Math.PI / 180);
                const dy = (next.lat - waypoint.lat) * 111320;
                const dz = next.alt - waypoint.alt;
                const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);
                delay = (dist / animationSpeed) * 1000;
            }

            setTimeout(() => {
                animationId = requestAnimationFrame(animate);
            }, Math.max(10, delay));
        }

        function updateUI() {
            const waypoint = waypointData[currentIndex];
            const progress = (currentIndex / (waypointData.length - 1)) * 100;
            
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
            document.getElementById('currentWaypoint').textContent = `${currentIndex + 1} / ${waypointData.length}`;
            document.getElementById('longitude').textContent = waypoint.lon.toFixed(6) + 'Â°';
            document.getElementById('latitude').textContent = waypoint.lat.toFixed(6) + 'Â°';
            document.getElementById('altitude').textContent = waypoint.alt.toFixed(2) + ' m';
            document.getElementById('routeId').textContent = waypoint.route;
            
            // èˆªçº¿çŠ¶æ€æ˜¾ç¤º
            const routeStatus = document.getElementById('routeStatus');
            if (waypoint.type === 3) {
                routeStatus.textContent = 'æ¸…æ´—ä½œä¸šä¸­';
                routeStatus.style.color = '#27ae60';
                routeStatus.style.fontWeight = 'bold';
            } else {
                routeStatus.textContent = 'æ­£åœ¨å‰å¾€ä¸‹ä¸€æ¸…æ´—èˆªçº¿';
                routeStatus.style.color = '#e67e22';
                routeStatus.style.fontWeight = 'bold';
            }
            
            const sprayStatus = document.getElementById('sprayStatus');
            if (waypoint.type === 3) {
                sprayStatus.textContent = 'å¼€å¯ ğŸ’§';
                sprayStatus.className = 'status-on';
            } else {
                sprayStatus.textContent = 'å…³é—­ â­•';
                sprayStatus.className = 'status-off';
            }

            document.getElementById('cleanedDistance').textContent = cleanedDistance.toFixed(2) + ' m';
            document.getElementById('remainingDistance').textContent = (totalDistance - cleanedDistance).toFixed(2) + ' m';
            document.getElementById('coverageRate').textContent = ((cleanedDistance / totalDistance) * 100).toFixed(1) + ' %';
        }

        function drawDrone(waypoint) {
            // ç§»é™¤æ—§æ ‡è®°
            if (droneMarker) routeLayer.removeLayer(droneMarker);

            // ç»˜åˆ¶æ— äººæœºæ ‡è®° - ä½¿ç”¨ divIcon æ¥ä¿æŒåŸå›¾æ¯”ä¾‹
            const droneIcon = L.divIcon({
                html: '<img src="cleaning_UAV.png" style="width: 100%; height: 100%; object-fit: contain;">',
                iconSize: [50, 50],
                iconAnchor: [25, 25],
                popupAnchor: [0, -25],
                className: 'drone-marker'
            });

            droneMarker = L.marker([waypoint.lat, waypoint.lon], { icon: droneIcon })
                .bindPopup(`æ— äººæœº<br>é«˜åº¦: ${waypoint.alt.toFixed(2)}m`)
                .addTo(routeLayer);

            // æ‰“å¼€å¼¹çª—
            droneMarker.openPopup();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–åœ°å›¾
        window.addEventListener('load', function() {
            initMap();
        });
    </script>
</body>
</html>
